{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Step 2: Metadata Samples for Genomic Data</h2>
    
    <!-- <form action="" method="post" id="wizard-form"> -->
    <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ wizard.management_form }}
    
    <div id="sample-formset">
        {{ wizard.form.management_form }} {% for form in wizard.form %}
            <div class="sample-row mb-3 p-3 border">
                {{ form.as_p }}
            </div>
        {% endfor %}
    </div>
       <div class="mt-3">
    <button type="button" id="add-sample" class="btn btn-secondary">Add Another Sample</button>
        </div>

        <div class="mt-5 border-top pt-3">
        
        <button name="wizard_goto_step" type="submit" value="{{ wizard.steps.prev }}" class="btn btn-secondary">Back</button>

     <button type="submit" class="btn btn-primary">Next</button>
    </div>
             
</form>
</div>

<script>
 document.getElementById('add-sample').onclick = function() {
    // 1. Find the Management Form field
    const totalForms = document.getElementById('id_samples-TOTAL_FORMS');
    const formNum = parseInt(totalForms.value);

    // 2. Clone the last sample row
    const container = document.getElementById('sample-formset');
    const allRows = container.getElementsByClassName('sample-row');
    const newForm = allRows[0].cloneNode(true); // Clone the first one as a template

    // 3. Update the index in all IDs and Names (0 -> 1, 1 -> 2, etc.)
    // This regex looks for "samples-0-" and replaces it with "samples-1-"
    newForm.innerHTML = newForm.innerHTML.replace(/samples-\d-/g, `samples-${formNum}-`);

    // 4. Clear values in the new row so it's not a duplicate of data
    const inputs = newForm.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (input.type !== 'hidden') input.value = '';
    });

    // 5. Add to page and INCREMENT the total count
    container.appendChild(newForm);
    totalForms.value = formNum + 1; // THIS IS THE CRITICAL LINE
};
</script>
{% endblock %}